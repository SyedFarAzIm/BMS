<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Place Order - Bakery Management System</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        .product-list-item {
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            background: white;
            margin-bottom: 15px;
        }
        .product-list-item:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-color: #007bff;
        }
        .product-image {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 8px;
        }
        .product-placeholder {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #dee2e6;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .quantity-btn:hover {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .quantity-input {
            width: 60px;
            text-align: center;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 5px;
        }
        .order-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
        }
        .discount-badge {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.875rem;
        }
        .total-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #e9ecef;
        }
        .list-header {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 15px;
            font-weight: bold;
            color: #495057;
        }
        
        /* Fixed column spacing */
        .product-image-col {
            flex: 0 0 80px;
            max-width: 80px;
        }
        .product-name-col {
            flex: 1;
            min-width: 0;
            padding-left: 15px;
        }
        .product-price-col {
            flex: 0 0 100px;
            max-width: 100px;
        }
        .product-qty-col {
            flex: 0 0 140px;
            max-width: 140px;
        }
        .product-action-col {
            flex: 0 0 100px;
            max-width: 100px;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">
                <i class="fas fa-cookie me-2 text-warning"></i>Bakery Management System
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('admin_dashboard') }}">
                    <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                </a>
                <a class="nav-link" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <!-- Products Section -->
            <div class="col-lg-8">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0 fw-bold">
                            <i class="fas fa-shopping-basket me-2"></i>Available Products
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <!-- List Header - Fixed Column Widths -->
                        <div class="list-header d-none d-md-flex">
                            <div class="product-image-col text-center">Image</div>
                            <div class="product-name-col">Product Name</div>
                            <div class="product-price-col text-center">Price</div>
                            <div class="product-qty-col text-center">Quantity</div>
                            <div class="product-action-col text-center">Action</div>
                        </div>

                        <!-- Products List -->
                        <div id="productsList">
                            {% for product in products %}
                            <div class="product-list-item p-3">
                                <!-- Desktop Layout -->
                                <div class="d-none d-md-flex align-items-center">
                                    <!-- Product Image -->
                                    <div class="product-image-col text-center">
                                        {% if product.image %}
                                        <img src="{{ url_for('static', filename='uploads/' + product.image) }}" 
                                             class="product-image" 
                                             alt="{{ product.name }}"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        <div class="product-placeholder" style="display: none;">
                                            <i class="fas fa-cookie text-muted"></i>
                                        </div>
                                        {% else %}
                                        <div class="product-placeholder mx-auto">
                                            <i class="fas fa-cookie text-muted"></i>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- Product Info -->
                                    <div class="product-name-col">
                                        <h6 class="fw-bold text-dark mb-1">{{ product.name }}</h6>
                                        <small class="text-muted">{{ product.category }}</small>
                                    </div>

                                    <!-- Price -->
                                    <div class="product-price-col text-center">
                                        <span class="h6 text-success fw-bold mb-0">
                                            ${{ "%.2f"|format(product.price) }}
                                        </span>
                                    </div>

                                    <!-- Quantity Controls -->
                                    <div class="product-qty-col">
                                        <div class="quantity-controls justify-content-center">
                                            <div class="quantity-btn" onclick="changeQuantity({{ product.id }}, -1)">
                                                <i class="fas fa-minus fa-sm"></i>
                                            </div>
                                            <input type="number" class="quantity-input" 
                                                   id="qty-{{ product.id }}" 
                                                   value="1" min="1" max="99"
                                                   onchange="validateQuantity({{ product.id }})">
                                            <div class="quantity-btn" onclick="changeQuantity({{ product.id }}, 1)">
                                                <i class="fas fa-plus fa-sm"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Add Button -->
                                    <div class="product-action-col text-center">
                                        <button class="btn btn-primary btn-sm fw-bold w-100" 
                                                onclick="addToOrder({{ product.id }}, '{{ product.name }}', {{ product.price }})">
                                            <i class="fas fa-cart-plus me-1"></i>Add
                                        </button>
                                    </div>
                                </div>

                                <!-- Mobile Layout -->
                                <div class="d-block d-md-none">
                                    <div class="row align-items-center">
                                        <!-- Product Image & Info -->
                                        <div class="col-8 d-flex align-items-center">
                                            {% if product.image %}
                                            <img src="{{ url_for('static', filename='uploads/' + product.image) }}" 
                                                 class="product-image me-3" 
                                                 alt="{{ product.name }}"
                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                            <div class="product-placeholder me-3" style="display: none;">
                                                <i class="fas fa-cookie text-muted"></i>
                                            </div>
                                            {% else %}
                                            <div class="product-placeholder me-3">
                                                <i class="fas fa-cookie text-muted"></i>
                                            </div>
                                            {% endif %}
                                            <div>
                                                <h6 class="fw-bold text-dark mb-1">{{ product.name }}</h6>
                                                <small class="text-muted d-block">{{ product.category }}</small>
                                                <span class="h6 text-success fw-bold">
                                                    ${{ "%.2f"|format(product.price) }}
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Mobile Controls -->
                                        <div class="col-4 text-end">
                                            <div class="quantity-controls justify-content-end mb-2">
                                                <div class="quantity-btn" onclick="changeQuantity({{ product.id }}, -1)">
                                                    <i class="fas fa-minus fa-sm"></i>
                                                </div>
                                                <input type="number" class="quantity-input" 
                                                       id="qty-mob-{{ product.id }}" 
                                                       value="1" min="1" max="99"
                                                       onchange="validateQuantity({{ product.id }})">
                                                <div class="quantity-btn" onclick="changeQuantity({{ product.id }}, 1)">
                                                    <i class="fas fa-plus fa-sm"></i>
                                                </div>
                                            </div>
                                            <button class="btn btn-primary btn-sm fw-bold w-100" 
                                                    onclick="addToOrder({{ product.id }}, '{{ product.name }}', {{ product.price }})">
                                                <i class="fas fa-cart-plus me-1"></i>Add
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        {% if not products %}
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-cookie fa-3x mb-3 opacity-50"></i>
                            <h5>No Products Available</h5>
                            <p>Please add products first to start placing orders.</p>
                            <a href="{{ url_for('manage_products') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-1"></i>Add Products
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Order Summary Section -->
            <div class="col-lg-4">
                <!-- Order Summary -->
                <div class="card shadow-sm border-0 mb-3">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0 fw-bold">
                            <i class="fas fa-receipt me-2"></i>Order Summary
                        </h5>
                    </div>
                    <div class="card-body p-3">
                        <div id="orderSummary">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-shopping-cart fa-2x mb-2 opacity-50"></i>
                                <p class="mb-0">No items added yet</p>
                                <small>Start adding products to your order</small>
                            </div>
                        </div>
                        
                        <!-- Discount Section -->
                        <div id="discountSection" class="mt-3 p-3 border rounded-3" 
                             style="display: none; background: linear-gradient(135deg, #d4edda, #c3e6cb);">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="discount-badge">
                                        <i class="fas fa-percentage me-1"></i>4% OFF
                                    </div>
                                    <small class="text-success fw-bold mt-1 d-block">Order over $150 qualifies!</small>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" 
                                           id="applyDiscountCheckbox" onchange="toggleDiscount()">
                                </div>
                            </div>
                        </div>

                        <!-- Total Section -->
                        <div class="total-section mt-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Subtotal:</span>
                                <span id="subtotalAmount" class="fw-bold">$0.00</span>
                            </div>
                            
                            <div id="discountRow" class="d-flex justify-content-between mb-2 text-success" 
                                 style="display: none !important;">
                                <span class="fw-bold">
                                    <i class="fas fa-percentage me-1"></i>Discount (4%):
                                </span>
                                <span id="discountAmount" class="fw-bold">-$0.00</span>
                            </div>
                            
                            <hr class="my-2">
                            <div class="d-flex justify-content-between">
                                <span class="h6 fw-bold text-dark">Total:</span>
                                <span id="totalAmount" class="h5 fw-bold text-primary">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer Information -->
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0 fw-bold">
                            <i class="fas fa-user me-2"></i>Customer Information
                        </h5>
                    </div>
                    <div class="card-body p-3">
                        <form id="orderForm" onsubmit="submitOrder(event)">
                            <div class="mb-3">
                                <label for="customer_name" class="form-label fw-bold">
                                    Customer Name <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control form-control-lg" 
                                       id="customer_name" name="customer_name" 
                                       placeholder="Enter customer name" required>
                            </div>
                            
                            <button type="submit" class="btn btn-success btn-lg w-100 fw-bold" 
                                    id="placeOrderBtn" disabled>
                                <i class="fas fa-shopping-cart me-2"></i>Place Order
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="card shadow-sm border-0 mt-3 bg-light">
                    <div class="card-body p-3 text-center">
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="text-primary">
                                    <i class="fas fa-shopping-bag"></i>
                                    <div class="fw-bold" id="itemCount">0</div>
                                    <small class="text-muted">Items</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-success">
                                    <i class="fas fa-coins"></i>
                                    <div class="fw-bold" id="itemTotal">$0.00</div>
                                    <small class="text-muted">Total</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let orderItems = [];
        let isDiscountApplied = false;
        let discountAmount = 0;
        let subtotalAmount = 0;

        // Updated quantity control functions to handle both desktop and mobile
        function changeQuantity(productId, delta) {
            const qtyInput = document.getElementById(`qty-${productId}`) || document.getElementById(`qty-mob-${productId}`);
            let currentQty = parseInt(qtyInput.value) || 1;
            let newQty = currentQty + delta;
            
            if (newQty < 1) newQty = 1;
            if (newQty > 99) newQty = 99;
            
            qtyInput.value = newQty;
            
            // Sync both inputs if they exist
            const desktopInput = document.getElementById(`qty-${productId}`);
            const mobileInput = document.getElementById(`qty-mob-${productId}`);
            if (desktopInput && mobileInput) {
                desktopInput.value = newQty;
                mobileInput.value = newQty;
            }
        }

        function validateQuantity(productId) {
            const qtyInput = document.getElementById(`qty-${productId}`) || document.getElementById(`qty-mob-${productId}`);
            let qty = parseInt(qtyInput.value) || 1;
            
            if (qty < 1) qty = 1;
            if (qty > 99) qty = 99;
            
            qtyInput.value = qty;
            
            // Sync both inputs if they exist
            const desktopInput = document.getElementById(`qty-${productId}`);
            const mobileInput = document.getElementById(`qty-mob-${productId}`);
            if (desktopInput && mobileInput) {
                desktopInput.value = qty;
                mobileInput.value = qty;
            }
        }

        function addToOrder(productId, productName, productPrice) {
            const qtyInput = document.getElementById(`qty-${productId}`) || document.getElementById(`qty-mob-${productId}`);
            const quantity = parseInt(qtyInput.value) || 1;
            
            // Check if item already exists
            const existingItem = orderItems.find(item => item.id === productId);
            
            if (existingItem) {
                existingItem.quantity += quantity;
                showNotification(`Added ${quantity} more ${productName} to order`, 'success');
            } else {
                orderItems.push({
                    id: productId,
                    name: productName,
                    price: productPrice,
                    quantity: quantity
                });
                showNotification(`${quantity} Ã— ${productName} added to order`, 'success');
            }
            
            // Reset quantity to 1 for both inputs
            const desktopInput = document.getElementById(`qty-${productId}`);
            const mobileInput = document.getElementById(`qty-mob-${productId}`);
            if (desktopInput) desktopInput.value = 1;
            if (mobileInput) mobileInput.value = 1;
            
            updateOrderSummary();
        }

        function updateItemQuantity(productId, newQuantity) {
            if (newQuantity <= 0) {
                removeFromOrder(productId);
                return;
            }
            
            const item = orderItems.find(item => item.id === productId);
            if (item) {
                item.quantity = newQuantity;
                updateOrderSummary();
            }
        }

        function removeFromOrder(productId) {
            const itemIndex = orderItems.findIndex(item => item.id === productId);
            if (itemIndex > -1) {
                const removedItem = orderItems[itemIndex];
                orderItems.splice(itemIndex, 1);
                showNotification(`${removedItem.name} removed from order`, 'info');
                updateOrderSummary();
            }
        }

        function updateOrderSummary() {
            const summaryDiv = document.getElementById('orderSummary');
            const subtotalElement = document.getElementById('subtotalAmount');
            const totalElement = document.getElementById('totalAmount');
            const discountSection = document.getElementById('discountSection');
            const discountRow = document.getElementById('discountRow');
            const discountAmountElement = document.getElementById('discountAmount');
            const placeOrderBtn = document.getElementById('placeOrderBtn');
            const itemCountElement = document.getElementById('itemCount');
            const itemTotalElement = document.getElementById('itemTotal');
            
            if (orderItems.length === 0) {
                summaryDiv.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-shopping-cart fa-2x mb-2 opacity-50"></i>
                        <p class="mb-0">No items added yet</p>
                        <small>Start adding products to your order</small>
                    </div>
                `;
                subtotalElement.textContent = '$0.00';
                totalElement.textContent = '$0.00';
                itemCountElement.textContent = '0';
                itemTotalElement.textContent = '$0.00';
                discountSection.style.display = 'none';
                discountRow.style.display = 'none';
                placeOrderBtn.disabled = true;
                return;
            }

            // Calculate subtotal and item count
            subtotalAmount = orderItems.reduce((total, item) => total + (item.price * item.quantity), 0);
            const totalItems = orderItems.reduce((total, item) => total + item.quantity, 0);
            
            // Show/hide discount section
            if (subtotalAmount >= 150) {
                discountSection.style.display = 'block';
            } else {
                discountSection.style.display = 'none';
                if (isDiscountApplied) {
                    document.getElementById('applyDiscountCheckbox').checked = false;
                    isDiscountApplied = false;
                    discountRow.style.display = 'none';
                }
            }

            // Calculate discount
            discountAmount = isDiscountApplied ? subtotalAmount * 0.04 : 0;
            const finalTotal = subtotalAmount - discountAmount;

            // Update display
            let summaryHTML = '';
            orderItems.forEach(item => {
                summaryHTML += `
                    <div class="order-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-bold">${item.name}</h6>
                                <small class="text-muted">$${item.price.toFixed(2)} each</small>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold text-success">$${(item.price * item.quantity).toFixed(2)}</div>
                                <div class="d-flex align-items-center gap-2 mt-1">
                                    <div class="d-flex align-items-center gap-1">
                                        <button class="btn btn-sm btn-outline-secondary p-1" 
                                                onclick="updateItemQuantity(${item.id}, ${item.quantity - 1})"
                                                style="width: 24px; height: 24px;">
                                            <i class="fas fa-minus fa-xs"></i>
                                        </button>
                                        <span class="fw-bold px-2">${item.quantity}</span>
                                        <button class="btn btn-sm btn-outline-secondary p-1" 
                                                onclick="updateItemQuantity(${item.id}, ${item.quantity + 1})"
                                                style="width: 24px; height: 24px;">
                                            <i class="fas fa-plus fa-xs"></i>
                                        </button>
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger p-1" 
                                            onclick="removeFromOrder(${item.id})"
                                            style="width: 24px; height: 24px;">
                                        <i class="fas fa-trash fa-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            summaryDiv.innerHTML = summaryHTML;
            subtotalElement.textContent = `$${subtotalAmount.toFixed(2)}`;
            itemCountElement.textContent = totalItems.toString();
            itemTotalElement.textContent = `$${finalTotal.toFixed(2)}`;
            
            // Show/hide discount row
            if (isDiscountApplied && discountAmount > 0) {
                discountRow.style.display = 'flex';
                discountAmountElement.textContent = `-$${discountAmount.toFixed(2)}`;
            } else {
                discountRow.style.display = 'none';
            }
            
            totalElement.textContent = `$${finalTotal.toFixed(2)}`;
            placeOrderBtn.disabled = false;
        }

        function toggleDiscount() {
            const checkbox = document.getElementById('applyDiscountCheckbox');
            isDiscountApplied = checkbox.checked;
            updateOrderSummary();
            
            if (isDiscountApplied) {
                showNotification('4% discount applied to your order!', 'success');
            } else {
                showNotification('Discount removed from order', 'info');
            }
        }

        function submitOrder(event) {
            event.preventDefault();
            
            if (orderItems.length === 0) {
                showNotification('Please add items to your order', 'error');
                return;
            }
            
            const formData = new FormData(event.target);
            
            // Add order data
            formData.append('order_items', JSON.stringify(orderItems));
            formData.append('discount_applied', isDiscountApplied);
            formData.append('discount_amount', discountAmount.toFixed(2));
            formData.append('subtotal_amount', subtotalAmount.toFixed(2));
            
            // Add default values for optional fields
            formData.append('customer_email', '');
            formData.append('customer_phone', '');
            formData.append('payment_method', 'cash');
            
            // Show loading state
            const submitBtn = document.getElementById('placeOrderBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing Order...';
            submitBtn.disabled = true;
            
            fetch('/manager/place-order', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Order placed successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 1500);
                } else {
                    showNotification(data.message || 'Failed to place order', 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An error occurred while placing the order', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        }

        function showNotification(message, type = 'info') {
            const alertClass = type === 'error' ? 'danger' : type;
            const notification = document.createElement('div');
            notification.className = `alert alert-${alertClass} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 350px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);';
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    <div>${message}</div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>


